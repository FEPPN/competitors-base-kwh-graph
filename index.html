<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>TRVE (Base) vs Prix moyen concurrents — Base 6 kVA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body{margin:0;overflow:hidden;background:#fff;font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,sans-serif;display:flex;justify-content:center;padding:40px 16px;}
    .chart-wrapper{background:transparent;border-radius:0;box-shadow:none;padding:0;}
    h1{margin:0 0 14px;text-align:center;font-size:22px;font-weight:600;color:#0b0f19;}
    .legend-note{margin:2px 0 12px;text-align:center;color:#64748b;font-size:13px;}
    canvas{width:100% !important;height:auto !important;}
  </style>
</head>
<body>
  <div class="chart-wrapper">
    <h1>Évolution du prix du kWh — TRVE (Base) vs Moyenne marché</h1>
    <div class="legend-note">Profil particulier • Base 6 kVA • Unités : €/kWh <strong>TTC</strong></div>
    <canvas id="chart"></canvas>
  </div>

  <script>
    // Sources
    const trveUrl = "https://raw.githubusercontent.com/FEPPN/graph_historical_TRVE/main/data.json"; // on prend UNIQUEMENT AVG (BASE)
    const competitorsUrl = "https://raw.githubusercontent.com/feppn/competitors-base-kwh-graph/main/data_competitors.json";

    // Helpers
    const ymKey = d => {
      const dt = new Date(d);
      return dt.getFullYear() + "-" + String(dt.getMonth()+1).padStart(2,"0");
    };
    const ymToLabel = key => {
      const [y,m] = key.split("-");
      return new Date(Number(y), Number(m)-1, 1).toLocaleDateString("fr-FR",{year:"numeric",month:"2-digit"});
    };

    Promise.all([
      fetch(trveUrl + "?v=" + Date.now(), {cache:"no-store"}).then(r=>r.json()),
      fetch(competitorsUrl + "?v=" + Date.now(), {cache:"no-store"}).then(r=>r.json())
    ])
    .then(([trveRows, compRows]) => {
      // ---- TRVE (BASE uniquement) : on lit UNIQUEMENT r.AVG, on ignore Forecast2026 ----
      const trveIdx = {};
      trveRows
        .filter(r => r.Date && typeof r.AVG === "number")   // BASE uniquement
        .forEach(r => { trveIdx[ymKey(r.Date)] = r.AVG; });

      // ---- Concurrents : tout le fichier, valeurs numérisées même si string ----
      const compIdx = {};
      (compRows || []).forEach(r => {
        const v = (typeof r.CompetitorAVG === "number") ? r.CompetitorAVG : Number(String(r.CompetitorAVG).replace(",","."));
        if (!Number.isNaN(v)) compIdx[ymKey(r.Date)] = v;
      });

      // ---- Union des mois (toutes les dates présentes dans l’un OU l’autre) ----
      const monthsSet = new Set([...Object.keys(trveIdx), ...Object.keys(compIdx)]);
      const months = Array.from(monthsSet).sort(); // "YYYY-MM" triés
      const labels = months.map(ymToLabel);

      // Séries alignées
      const trveVals = months.map(k => (k in trveIdx ? trveIdx[k] : null));
      const compVals = months.map(k => (k in compIdx ? compIdx[k] : null));

      // Chart
      const ctx = document.getElementById("chart").getContext("2d");

      const gTrve = ctx.createLinearGradient(0,0,0,300);
      gTrve.addColorStop(0,"rgba(90, 82, 255, 0.22)");
      gTrve.addColorStop(1,"rgba(90, 82, 255, 0.00)");

      const gComp = ctx.createLinearGradient(0,0,0,300);
      gComp.addColorStop(0,"rgba(51,65,85,0.15)");
      gComp.addColorStop(1,"rgba(51,65,85,0.00)");

      new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: "TRVE – Tarif réglementé (Base 6 kVA)",
              data: trveVals,
              borderColor: "#5a52ff",
              backgroundColor: gTrve,
              borderWidth: 1.6,
              pointRadius: 0,
              spanGaps: true,
              stepped: "before",
              tension: 0,
              fill: true
            },
            {
              label: "Prix moyen marché (Engie / TotalEnergies / Plénitude)",
              data: compVals,
              borderColor: "#334155",
              backgroundColor: gComp,
              borderWidth: 1.6,
              pointRadius: 0,
              spanGaps: true,
              stepped: "before",
              tension: 0,
              fill: true
            }
          ]
        },
        options: {
          responsive: true,
          interaction: { mode: 'nearest', intersect: false },
          plugins: {
            legend: {
              position: "bottom",
              labels: { color: "#1f2937", font: { size: 13, weight: "600" } }
            },
            tooltip: {
              backgroundColor:"#fff", borderColor:"#e5e7eb", borderWidth:1,
              titleColor:"#111827", bodyColor:"#4b5563",
              titleFont:{ weight:'700' }, bodyFont:{ weight:'500' },
              padding:10, cornerRadius:10,
              callbacks: {
                label: (ctx) => `${ctx.dataset.label} : ${typeof ctx.parsed.y==="number" ? ctx.parsed.y.toFixed(4)+" € / kWh TTC" : "—"}`
              }
            }
          },
          scales: {
            y: {
              ticks: { color:"#6b7280", callback: v => `${Number(v).toFixed(3)} €` },
              grid: { color:"rgba(0,0,0,0.06)" },
              border: { display:false }
            },
            x: {
              offset : true,
              ticks: { color:"#6b7280", maxRotation:0, autoSkip:true, maxTicksLimit:12 },
              grid: { display:false },
              border: { display:false }
            }
          }
        }
      });
    })
    .catch(err => {
      console.error(err);
      document.querySelector(".chart-wrapper").insertAdjacentHTML(
        "beforeend",
        `<p style="margin-top:10px;color:#ef4444;text-align:center">Erreur de chargement des données.</p>`
      );
    });
  </script>
</body>
</html>
